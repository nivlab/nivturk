<!DOCTYPE html>
<html>
<head>
  <title>Decision Making Experiment</title>

  <!-- Load libraries -->
  <script src="../static/lib/jquery-3.3.1/jquery.min.js"></script>
  <script src="../static/lib/jspsych-7.2.1/jspsych.js"></script>

  <!-- Load jsPsych plug-ins -->
  <script src="../static/lib/jspsych-7.2.1/plugins/plugin-survey-likert.js"></script>

  <!-- Load CSS styles -->
  <link href="../static/lib/jspsych-7.2.1/css/jspsych.css" rel="stylesheet" type="text/css"></link>

</head>
<body></body>
<script>

  // Display alert message on back/refresh.
  // https://developer.mozilla.org/en-US/docs/Web/API/WindowEventHandlers/onbeforeunload
  function verify_unload(e){
    e.preventDefault();
    (e || window.event).returnValue = null;
    incompleteSave();  // Saves incomplete data.
    return null;
  };
  window.addEventListener("beforeunload", verify_unload);

  // Define example survey.
  var likert_page = {
    type: jsPsychSurveyLikert,
    questions: [{prompt: "Are you seeing something right now?", labels: ["Yes", "No"]}],
    on_start: function(data) {
      passMessage('message to pass to nivturk');
    }
  };

  // Define global variables.
  var low_quality = false;

  // Initialize timeline.
  var timeline = [likert_page];

  // Initialize jsPsych.
  var jsPsych = initJsPsych({
    on_finish: function() {

      // Remove requirement to verify redirect
      window.removeEventListener("beforeunload", verify_unload);

      // Add interactions to the data variable
      var interaction_data = jsPsych.data.getInteractionData();
      jsPsych.data.get().addToLast({interactions: interaction_data.json()});

      // Display jsPsych data in viewport.
      // jsPsych.data.displayData();

      // Redirect participant & save data.
      var tryCount = 0;
      var retryLimit = 3;
      redirectUser(Number(low_quality), "{{code_success}}", "{{code_reject}}", tryCount, retryLimit);

    }
  });

  // Execute timeline.
  jsPsych.run(timeline);

</script>
<script>

  // Pass message from jsPsych to NivTurk
  function passMessage(msg) {

    $.ajax({
      url: "/experiment",
      method: 'POST',
      data: JSON.stringify(msg),
      contentType: "application/json; charset=utf-8",
    }).done(function(data, textStatus, jqXHR) {
      // do nothing on success
    }).fail(function(error) {
      // do nothing on failure
    });

  }

  // Save an incomplete dataset.
  function incompleteSave() {

    $.ajax({
      url: "/incomplete_save",
      method: 'POST',
      data: JSON.stringify(jsPsych.data.get().json()),
      contentType: "application/json; charset=utf-8",
    }).done(function(data, textStatus, jqXHR) {
      // do nothing on success
    }).fail(function(error) {
      // do nothing on failure
    });

  }

  /**
  * Redirect user on completion of experiment.
  * @param  {int}    status        Status of participant (success = 0, reject = 1, error = all else).
  * @param  {string} code_success  Completion code on success.
  * @param  {string} code_reject   Completion code on reject.
  * @param  {int}    tryCount      Current number of data saving attempts.
  * @param  {int}    retryLimit    Maximum number of data saving attempts.
  */
  function redirectUser(status, code_success, code_reject, tryCount, retryLimit) {

    // Define redirect URL.
    switch (status) {
      case 0:
        var internal_url = "/redirect_success";
        var external_url = "https://app.prolific.co/submissions/complete?cc=" + code_success;
        break;
      case 1:
        var internal_url = "/redirect_reject";
        var external_url = "https://app.prolific.co/submissions/complete?cc=" + code_reject;
        break;
      default:
        var internal_url = "/redirect_error";
        var external_url = "/error/" + status;
    }

    // Perform AJAX call.
    $.ajax({
      url: internal_url,
      method: 'POST',
      data: JSON.stringify(jsPsych.data.get().json()),
      contentType: "application/json; charset=utf-8",
    }).done(function(data, textStatus, jqXHR) {
      window.location.replace(external_url);
    }).fail(function(error) {
      errorHandling(status, code_success, code_reject, tryCount, retryLimit);
    });

  }

  /**
  * Handle data saving errors.
  * @param  {int}    status        Status of participant (success = 0, reject = 1, error = all else).
  * @param  {string} code_success  Completion code on success.
  * @param  {string} code_reject   Completion code on reject.
  * @param  {int}    tryCount      Current number of data saving attempts.
  * @param  {int}    retryLimit    Maximum number of data saving attempts.
  */
  function errorHandling(status, code_success, code_reject, tryCount, retryLimit) {

    // Increment counter.
    tryCount++;

    // Method #1: Lost internet connection.
    if (!navigator.onLine) {

      // Define & display error message.
      const msg = "<h3>No internet connection detected.</h3>" +
                  "<p>Once you are reconnected, please press the button below.</p>" +
                  "<button type='button' class='jspsych-btn' id='jspsych-error-button'>Continue</button>";
      document.getElementById("jspsych-content").innerHTML = msg;

      // Add event listener.
      document.getElementById("jspsych-error-button").addEventListener("click", function(event) {
        redirectUser(status, code_success, code_reject, tryCount, retryLimit)
      });

    // Method #2: Wait and retry.
    } else if (tryCount <= retryLimit) {

      // Define & display error message.
      const msg = "<h3>Oops, we ran into trouble while trying to save your data.</h3>" +
                  "<p>Retrying automatically in 5 seconds (attempt " + tryCount + " of " + retryLimit + ").</p>" +
                  "<p><small><a href='#' id='jspsych-error-link'>Click here if nothing happens.</a></small></p>";
      document.getElementById("jspsych-content").innerHTML = msg;

      // Add event listener.
      document.getElementById("jspsych-error-link").addEventListener("click", function(event) {
        redirectUser(status, code_success, code_reject, tryCount, retryLimit)
      });

      // Wait 5 seconds and try again.
      setTimeout(() => {
        redirectUser(status, code_success, code_reject, tryCount, retryLimit)
      }, 5000);

    // Method #3: Display completion code.
    } else {

      // Define completion code.
      switch (status) {
        case 0:
          var completion_code = code_success;
          break;
        case 1:
          var completion_code = code_reject;
          break;
        default:
          var completion_code = status;
      }

      // Define & display error message.
      const msg = "<p>Sorry, we were unable to save your data.</p>" +
                  "<p>Your completion code is <b>" + completion_code + "</b></p>";
      document.getElementById("jspsych-content").innerHTML = msg;

      // Attempt to pass message to NivTurk.
      passMessage("Data saving failed after " + (tryCount-1) + " attempts." )

    }

  }

</script>
</html>
